name: Push to Gitea

on:
  push:
    branches:
      - main  # 根据需要修改为你想要监控的分支

jobs:
  push-to-gitea:
    runs-on: ubuntu-latest

    steps:
      # 检出当前 GitHub 仓库的代码
      - name: Checkout GitHub repository
        uses: actions/checkout@v3

      # 设置 Git 配置（在当前仓库范围内生效）
      - name: Set up Git configuration
        run: |
          git config --global user.name "KolinLoa"
          git config --global user.email "liukang861@yahoo.com"

      # 克隆 Gitea 仓库
      - name: Clone Gitea repository
        run: |
          git clone https://gitea.com/KolinLoa/jx3-DrytronII.git gitea-repo
        env:
          GIT_ASKPASS: /bin/echo
          GIT_PASSWORD: ${{ secrets.GITEA_TOKEN }}

      # 在 Gitea 仓库中设置 Git 配置
      - name: Set up Git configuration for Gitea repo
        run: |
          cd gitea-repo
          git config user.name "KolinLoa"
          git config user.email "liukang861@yahoo.com"

      # 使用 rsync 将 GitHub 仓库的文件复制到 Gitea 仓库中（排除 .git 目录）
      - name: Copy files to Gitea repo
        run: |
          rsync -av --exclude .git ./ gitea-repo/
          cd gitea-repo
          rm -rf gitea-repo  # 删除克隆仓库内的 `gitea-repo` 文件夹

      # 检查 Gitea 仓库是否有改动，如果没有改动，则强制提交一个空提交
      - name: Check for changes and commit
        run: |
          cd gitea-repo
          git status  # 检查是否有更改
          if [[ $(git status --porcelain) ]]; then
            git add .  # 添加文件
            git commit -m "$(git log -1 --pretty=%B)"  # 提交更改
          else
            git commit --allow-empty -m "Sync from GitHub: $(git log -1 --pretty=%B)"  # 如果没有更改，提交一个空提交
          fi

      # 强制推送到 Gitea
      - name: Push to Gitea with GitHub commit message
        run: |
          cd gitea-repo
          git push --force https://KolinLoa:${{ secrets.GITEA_TOKEN }}@gitea.com/KolinLoa/jx3-DrytronII.git
