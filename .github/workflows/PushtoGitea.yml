name: Sync to Gitea

on:
  push:
    branches:
      - main  # 根据需要修改为你想要监控的分支

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # 完整克隆整个历史记录

      - name: Set Git Identity
        run: |
          git config --global user.name "KolinLoa"
          git config --global user.email "liukang861@yahoo.com"

      - name: Configure Git for Gitea
        env:
          GITEA_URL: gitea.com
          GITEA_USERNAME: KolinLoa
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          git remote add gitea https://${{ env.GITEA_USERNAME }}:${{ env.GITEA_TOKEN }}@${{ env.GITEA_URL }}/KolinLoa/jx3-DrytronII.git
          git fetch gitea main  # 拉取 Gitea 仓库的历史记录
          git merge gitea/main --allow-unrelated-histories || true  # 忽略合并失败，继续执行

      - name: Resolve merge conflicts (auto-accept GitHub version)
        run: |
          # 如果有冲突，选择 GitHub 的版本覆盖 Gitea 的版本
          git checkout --theirs .github/workflows/PushtoGitea.yml  # 自动用 GitHub 版本覆盖冲突文件
          git add .  # 添加解决后的冲突文件
          git commit -m "Resolved merge conflict by accepting GitHub version"  # 提交解决后的文件

      - name: Push to Gitea
        run: |
          git push --force gitea main  # 强制推送更新到 Gitea
